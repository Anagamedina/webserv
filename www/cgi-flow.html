<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CGI Pipe Flow Architecture</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: #0a0a0f;
      color: #e2e8f0;
    }

    .mono {
      font-family: 'JetBrains Mono', monospace;
    }

    .pipe-flow {
      stroke-dasharray: 10;
      animation: flow 1s linear infinite;
    }

    @keyframes flow {
      to {
        stroke-dashoffset: -20;
      }
    }

    .data-packet {
      filter: drop-shadow(0 0 10px currentColor);
    }

    .glow-text {
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .process-box {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(59, 130, 246, 0.3);
      backdrop-filter: blur(10px);
    }

    .pipe-connector {
      stroke: #475569;
      stroke-width: 3;
      fill: none;
    }

    .pipe-active {
      stroke: #3b82f6;
      stroke-width: 4;
      filter: drop-shadow(0 0 8px #3b82f6);
    }

    .fd-label {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #fca5a5;
    }

    .step-active {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }
  </style>
</head>

<body class="min-h-screen p-4 md:p-8">

  <!-- Header -->
  <div class="max-w-7xl mx-auto mb-8">
    <h1
      class="text-4xl md:text-5xl font-bold mb-4 glow-text bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">
      CGI Pipe Architecture
    </h1>
    <p class="text-slate-400 text-lg max-w-3xl">
      Visualización del flujo de datos entre el Servidor Web (Parent) y el Proceso CGI (Child)
      usando pipes no bloqueantes y <code class="mono text-cyan-400">dup2()</code>.
    </p>
  </div>

  <!-- Controls -->
  <div class="max-w-7xl mx-auto mb-8 flex flex-wrap gap-4">
    <button onclick="resetAnimation()"
      class="px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg font-semibold transition-all flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
        </path>
      </svg>
      Reiniciar
    </button>
    <button onclick="toggleAnimation()" id="playBtn"
      class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-lg shadow-blue-500/25">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z" />
      </svg>
      <span id="playText">Iniciar Flujo</span>
    </button>
    <div class="flex items-center gap-2 px-4 py-2 bg-slate-900/50 rounded-lg border border-slate-700">
      <div class="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>
      <span class="text-sm text-slate-300">Non-blocking I/O</span>
    </div>
  </div>

  <!-- Main Diagram -->
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left: Parent Process -->
    <div class="process-box rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl"></div>

      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center border border-blue-500/30">
          <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
            </path>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-bold text-white">Parent Process</h2>
          <p class="text-sm text-slate-400 mono">pid = getpid()</p>
        </div>
      </div>

      <!-- Pipe In (Parent Side) -->
      <div
        class="mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700/50 relative group hover:border-blue-500/50 transition-colors">
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">PIPE_IN</span>
          <span class="fd-label px-2 py-1 rounded text-xs mono">fd[1] WRITE</span>
        </div>
        <p class="text-sm text-slate-300 mb-2">Request Body → CGI stdin</p>
        <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
          <div id="pipeInBar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 w-0 transition-all duration-300">
          </div>
        </div>
        <div id="packetIn"
          class="hidden absolute -right-2 top-1/2 w-4 h-4 bg-cyan-400 rounded-full data-packet transform -translate-y-1/2">
        </div>
      </div>

      <!-- Pipe Out (Parent Side) -->
      <div
        class="p-4 bg-slate-900/50 rounded-xl border border-slate-700/50 relative group hover:border-green-500/50 transition-colors">
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-green-400 uppercase tracking-wider">PIPE_OUT</span>
          <span class="fd-label px-2 py-1 rounded text-xs mono">fd[0] READ</span>
        </div>
        <p class="text-sm text-slate-300 mb-2">CGI stdout → Response</p>
        <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
          <div id="pipeOutBar"
            class="h-full bg-gradient-to-r from-green-500 to-emerald-400 w-0 transition-all duration-300"></div>
        </div>
        <div id="packetOut"
          class="hidden absolute -left-2 top-1/2 w-4 h-4 bg-green-400 rounded-full data-packet transform -translate-y-1/2">
        </div>
      </div>

      <!-- Code Snippet -->
      <div class="mt-6 p-3 bg-black/30 rounded-lg border border-slate-800">
        <code class="mono text-xs text-slate-400 block">
          <span class="text-purple-400">close</span>(pipe_in[<span class="text-orange-400">0</span>]); <span
            class="text-slate-600">// close read</span><br>
          <span class="text-purple-400">close</span>(pipe_out[<span class="text-orange-400">1</span>]); <span
            class="text-slate-600">// close write</span>
        </code>
      </div>
    </div>

    <!-- Center: Visualization -->
    <div class="relative flex items-center justify-center min-h-[400px]">
      <!-- SVG Connections -->
      <svg class="absolute inset-0 w-full h-full" style="z-index: 0;">
        <!-- Pipe In Connection (Top) -->
        <path id="connIn" d="M 50 150 Q 150 150 250 100" class="pipe-connector" />
        <path id="connInActive" d="M 50 150 Q 150 150 250 100" class="pipe-active hidden" />

        <!-- Pipe Out Connection (Bottom) -->
        <path id="connOut" d="M 250 300 Q 150 300 50 250" class="pipe-connector" />
        <path id="connOutActive" d="M 250 300 Q 150 300 50 250" class="pipe-active hidden" />

        <!-- Flow particles -->
        <circle id="flowIn" r="6" fill="#22d3ee" class="hidden data-packet">
          <animateMotion dur="1.5s" repeatCount="indefinite" path="M 50 150 Q 150 150 250 100" />
        </circle>
        <circle id="flowOut" r="6" fill="#4ade80" class="hidden data-packet">
          <animateMotion dur="1.5s" repeatCount="indefinite" path="M 250 300 Q 150 300 50 250" />
        </circle>
      </svg>

      <!-- Fork Visualization -->
      <div class="relative z-10 text-center">
        <div id="forkBadge"
          class="w-24 h-24 rounded-full bg-slate-800 border-2 border-slate-600 flex items-center justify-center mb-4 mx-auto transition-all duration-500">
          <span class="text-3xl font-bold text-slate-500">fork()</span>
        </div>
        <div id="forkStatus" class="text-sm font-mono text-slate-500">Esperando...</div>

        <!-- dup2 arrows -->
        <div id="dup2Visual" class="hidden mt-8 space-y-2">
          <div class="flex items-center justify-center gap-2 text-xs mono text-cyan-400">
            <span>pipe_in[0]</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
            <span>STDIN_FILENO (0)</span>
          </div>
          <div class="flex items-center justify-center gap-2 text-xs mono text-green-400">
            <span>pipe_out[1]</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
            <span>STDOUT_FILENO (1)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Child Process -->
    <div class="process-box rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl"></div>

      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center border border-purple-500/30">
          <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
            </path>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-bold text-white">Child Process</h2>
          <p class="text-sm text-slate-400 mono" id="childPid">pid = 0</p>
        </div>
      </div>

      <!-- STDIN -->
      <div class="mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700/50">
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-cyan-400 uppercase tracking-wider">STDIN</span>
          <span class="fd-label px-2 py-1 rounded text-xs mono">fd 0</span>
        </div>
        <p class="text-sm text-slate-300">Recibe body del request</p>
        <div id="stdinData" class="mt-2 p-2 bg-black/30 rounded text-xs mono text-cyan-300 hidden">
          POST data...
        </div>
      </div>

      <!-- STDOUT -->
      <div class="mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700/50">
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-green-400 uppercase tracking-wider">STDOUT</span>
          <span class="fd-label px-2 py-1 rounded text-xs mono">fd 1</span>
        </div>
        <p class="text-sm text-slate-300">Envía respuesta CGI</p>
        <div id="stdoutData" class="mt-2 p-2 bg-black/30 rounded text-xs mono text-green-300 hidden">
          HTTP/1.1 200...
        </div>
      </div>

      <!-- execve -->
      <div class="p-4 bg-purple-900/20 rounded-xl border border-purple-500/30">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-bold text-purple-400 uppercase">execve()</span>
        </div>
        <code class="mono text-xs text-slate-300 block" id="execveCmd">
          <span class="text-slate-500"># Esperando...</span>
        </code>
      </div>
    </div>
  </div>

  <!-- Step by Step Explanation -->
  <div class="max-w-7xl mx-auto mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div id="step1" class="step-card p-4 rounded-xl border border-slate-700 bg-slate-900/30 transition-all">
      <div class="text-2xl font-bold text-slate-600 mb-2">01</div>
      <h3 class="font-semibold text-white mb-1">pipe()</h3>
      <p class="text-sm text-slate-400">Crear dos pipes: pipe_in[2] y pipe_out[2] para comunicación bidireccional.</p>
    </div>

    <div id="step2" class="step-card p-4 rounded-xl border border-slate-700 bg-slate-900/30 transition-all">
      <div class="text-2xl font-bold text-slate-600 mb-2">02</div>
      <h3 class="font-semibold text-white mb-1">fork()</h3>
      <p class="text-sm text-slate-400">Duplicar el proceso. Parent cierra extremos no usados, Child prepara
        redirección.</p>
    </div>

    <div id="step3" class="step-card p-4 rounded-xl border border-slate-700 bg-slate-900/30 transition-all">
      <div class="text-2xl font-bold text-slate-600 mb-2">03</div>
      <h3 class="font-semibold text-white mb-1">dup2()</h3>
      <p class="text-sm text-slate-400">Redirigir pipe_in[0] → STDIN (0) y pipe_out[1] → STDOUT (1).</p>
    </div>

    <div id="step4" class="step-card p-4 rounded-xl border border-slate-700 bg-slate-900/30 transition-all">
      <div class="text-2xl font-bold text-slate-600 mb-2">04</div>
      <h3 class="font-semibold text-white mb-1">execve()</h3>
      <p class="text-sm text-slate-400">Reemplazar proceso con script CGI. Parent escribe/lee de pipes de forma no
        bloqueante.</p>
    </div>
  </div>

  <!-- Data Flow Detail -->
  <div class="max-w-7xl mx-auto mt-8 p-6 bg-slate-900/30 rounded-2xl border border-slate-800">
    <h3 class="text-lg font-semibold mb-4 text-white">Detalle de File Descriptors</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mono text-sm">
      <div>
        <h4 class="text-blue-400 font-bold mb-2">Parent (Server)</h4>
        <ul class="space-y-2 text-slate-300">
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            <span>pipe_in[0] → <span class="text-slate-500">CLOSED</span></span>
          </li>
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
            <span>pipe_in[1] → WRITE (request body)</span>
          </li>
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-500"></span>
            <span>pipe_out[0] → READ (CGI output)</span>
          </li>
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            <span>pipe_out[1] → <span class="text-slate-500">CLOSED</span></span>
          </li>
        </ul>
      </div>
      <div>
        <h4 class="text-purple-400 font-bold mb-2">Child (CGI Script)</h4>
        <ul class="space-y-2 text-slate-300">
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-cyan-400"></span>
            <span>STDIN (0) ← pipe_in[0] (dup2)</span>
          </li>
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            <span>pipe_in[1] → <span class="text-slate-500">CLOSED</span></span>
          </li>
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            <span>pipe_out[0] → <span class="text-slate-500">CLOSED</span></span>
          </li>
          <li class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-400"></span>
            <span>STDOUT (1) ← pipe_out[1] (dup2)</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    let animationStep = 0;
    let isPlaying = false;
    let intervalId = null;

    function updateStep(step) {
      // Reset all steps
      document.querySelectorAll('.step-card').forEach((el, idx) => {
        if (idx + 1 === step) {
          el.classList.add('step-active', 'border-blue-500');
          el.classList.remove('border-slate-700');
        } else {
          el.classList.remove('step-active', 'border-blue-500');
          el.classList.add('border-slate-700');
        }
      });
    }

    function resetAnimation() {
      stopAnimation();
      animationStep = 0;
      isPlaying = false;
      updatePlayButton();

      // Reset visual elements
      document.getElementById('pipeInBar').style.width = '0%';
      document.getElementById('pipeOutBar').style.width = '0%';
      document.getElementById('packetIn').classList.add('hidden');
      document.getElementById('packetOut').classList.add('hidden');
      document.getElementById('connInActive').classList.add('hidden');
      document.getElementById('connOutActive').classList.add('hidden');
      document.getElementById('flowIn').classList.add('hidden');
      document.getElementById('flowOut').classList.add('hidden');
      document.getElementById('forkBadge').classList.remove('bg-blue-500', 'border-blue-400', 'text-white');
      document.getElementById('forkBadge').classList.add('bg-slate-800', 'border-slate-600', 'text-slate-500');
      document.getElementById('forkStatus').textContent = 'Esperando...';
      document.getElementById('forkStatus').classList.remove('text-blue-400');
      document.getElementById('dup2Visual').classList.add('hidden');
      document.getElementById('childPid').textContent = 'pid = 0';
      document.getElementById('childPid').classList.remove('text-purple-400');
      document.getElementById('execveCmd').innerHTML = '<span class="text-slate-500"># Esperando...</span>';
      document.getElementById('stdinData').classList.add('hidden');
      document.getElementById('stdoutData').classList.add('hidden');

      updateStep(0);
    }

    function stepAnimation() {
      animationStep++;

      switch (animationStep) {
        case 1:
          updateStep(1);
          // Pipe creation visual
          document.getElementById('connInActive').classList.remove('hidden');
          document.getElementById('connOutActive').classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('connInActive').classList.add('hidden');
            document.getElementById('connOutActive').classList.add('hidden');
          }, 800);
          break;

        case 2:
          updateStep(2);
          // Fork
          document.getElementById('forkBadge').classList.remove('bg-slate-800', 'border-slate-600', 'text-slate-500');
          document.getElementById('forkBadge').classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'scale-110');
          document.getElementById('forkStatus').textContent = 'pid = 0 (Child)';
          document.getElementById('forkStatus').classList.add('text-blue-400');
          document.getElementById('childPid').textContent = 'pid = ' + Math.floor(Math.random() * 10000 + 1000);
          document.getElementById('childPid').classList.add('text-purple-400');
          setTimeout(() => {
            document.getElementById('forkBadge').classList.remove('scale-110');
          }, 300);
          break;

        case 3:
          updateStep(3);
          // dup2
          document.getElementById('dup2Visual').classList.remove('hidden');
          document.getElementById('connInActive').classList.remove('hidden');
          document.getElementById('connOutActive').classList.remove('hidden');
          break;

        case 4:
          updateStep(4);
          // execve and data flow
          document.getElementById('execveCmd').innerHTML = '<span class="text-yellow-400">./script.py</span> <span class="text-slate-500"># CGI ejecutándose</span>';

          // Start data flow
          setTimeout(() => {
            document.getElementById('flowIn').classList.remove('hidden');
            document.getElementById('packetIn').classList.remove('hidden');
            document.getElementById('pipeInBar').style.width = '100%';
            document.getElementById('stdinData').classList.remove('hidden');
          }, 500);

          setTimeout(() => {
            document.getElementById('flowOut').classList.remove('hidden');
            document.getElementById('packetOut').classList.remove('hidden');
            document.getElementById('pipeOutBar').style.width = '100%';
            document.getElementById('stdoutData').classList.remove('hidden');
          }, 2000);
          break;

        case 5:
          stopAnimation();
          break;
      }
    }

    function toggleAnimation() {
      if (isPlaying) {
        stopAnimation();
      } else {
        startAnimation();
      }
    }

    function startAnimation() {
      isPlaying = true;
      updatePlayButton();
      if (animationStep === 0 || animationStep >= 4) {
        resetAnimation();
        setTimeout(() => {
          intervalId = setInterval(stepAnimation, 1500);
          stepAnimation();
        }, 100);
      } else {
        intervalId = setInterval(stepAnimation, 1500);
      }
    }

    function stopAnimation() {
      isPlaying = false;
      updatePlayButton();
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    function updatePlayButton() {
      const btn = document.getElementById('playBtn');
      const text = document.getElementById('playText');
      if (isPlaying) {
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-red-600');
        text.textContent = 'Pausar';
      } else {
        btn.classList.remove('bg-red-600');
        btn.classList.add('bg-blue-600');
        text.textContent = animationStep > 0 ? 'Continuar' : 'Iniciar Flujo';
      }
    }

    // Initialize
    resetAnimation();
  </script>
</body>

</html>
